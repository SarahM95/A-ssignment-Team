---
---
title: "Local_poison_regression"
author: "Gregoire Gasparini, Aurora Hofman, Beatriu Tort"
date: "24 de marzo de 2020"
output: pdf_document
---

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
library(splines)
```

#Loading and reading data:
```{r}
load("bikes.Washington.Rdata")
```

```{r}
cnt <- bikes$cnt
instant <- bikes$instant
```

#Excersice 1 ----------------------------------------------------------

##Estimate function using smooth.spline:
```{r}
m<- smooth.spline(x= instant, y= cnt) #uses GCV by default. 
```

```{r}
#Penalty parameter:
m$lambda

#Correstponding degrees of freedom:
m$df

#Number of knots: 
length(m$fit$knot)

```

```{r}
df<- tibble(instant, cnt, m$x, m$y)

g<- ggplot(data = df, aes(instant, cnt)) + geom_point() + geom_line(aes(m$x, m$y), colour = "red") + ggtitle("Estimated function and original data")
g
```

##Estimation using R bs and lm
```{r}
n.knots <- m$df - 4
my.knots <- quantile(instant, ((1:n.knots)-.5)/n.knots)

m_bs <- bs(instant, knots = my.knots, intercept=T)
m_lm <- lm(cnt~m_bs-1)


```

```{r}
df_tot <- tibble(instant, cnt, m_lm$fitted.values, m$y)
g_lm <- ggplot(data = df_tot, aes(instant, cnt)) + geom_point(colour = "red", shape= 1) + geom_line(aes(instant, m_lm$fitted.values), color = "blue") + geom_line(aes(instant, m$y), colour = "green") + ggtitle("Original data, cubic spline regression, unpenalized pline regrssion")
g_lm
```

Here is the color code :

- Red : initial data

- Green : smooth.spline() regression

- Blue : bs & lm regression


#Excersice 2 ---------------------------------------------------------------

```{r}
source('IRWLS_logistic_regression.R')

#Building the vector cnt.5000
cnt.5000 <- bikes$cnt > 5000
for (k in 1:length(cnt))
{
  if (cnt.5000[k] == TRUE) {cnt.5000[k] = 1} else {cnt.5000[k] = 0} # I changed from cnt.5000[1] til cnt.5000[k], (I do not know why if worked when the index was one, i would have thought that it did the same thing a lot of times, but if it is comman knowledge that it also works with 1 instead of k of course we can change it back)
}

#First, We sort the data according to the explanatory variable.
x <- bikes$temp
y <- cnt.5000
sx <- sort(x,index.return =TRUE)
x <- sx$x
y <- y[sx$ix]

#Now we can fit the model
my.spline.glm <- 
  logistic.IRWLS.splines(x,y,
                         df=6, #df = 6 as demanded in instructions
                         all.knots=FALSE, plts = FALSE) #all.knots=TRUE, Why did you chose this, I put it to false to make it run without warningmessages 

#Plot
plot(x,y,col=2,xlab="temp",ylab="cnt.5000",main = "IRWLS logistic regression")
abline(v=my.knots,lty=2,col="grey")
lines(x,my.spline.glm$fitted.values,col=4)
abline(h=0.5)

```

```{r}

probability = my.spline.glm$fitted.values

prob_above_50 <- (probability > 0.5)
indeces<-which(prob_above_50)
range<- c(x[indeces[1]], x[indeces[length(indeces)]])
range
#bit more efficient :) 

# flag = TRUE
# range=c(0,0)
# 
# #Getting the two ranges
# for (k in 1:length(probability))
# {
#   if (flag)
#     {
#     if (probability[k]>0.5)
#     {flag = FALSE
#     range[1] = k}
#     }
#   else
#     {
#     if (probability[k]>0.5)
#     {range[2] = k}
#     }
# }
# 
# range[1] = x[range[1]]
# range[2] = x[range[2]]
# range

```

The temperatures for which the chance of more than $5000$ bikes are rented is $20.74$ to $32.36$.











