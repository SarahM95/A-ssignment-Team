---
  title: "GAMs for Hirsutism data"
author: "Gregoire Gasparini, Aurora Hofman, Beatriu Tort"
date: "30 de marzo de 2020"
output: pdf_document
---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Hirsutism dataset

```{r}
hirs <- read.table("hirsutism.dat",header=T, sep="\t",fill=TRUE)
hirs$Treatment <- as.factor(hirs$Treatment)
summary(hirs)
```

```{r}
boxplot(hirs[,2:5])
par(mfrow=c(2,2))
boxplot(hirs[,2]~hirs$Treatment,ylim=c(0,30), main=names(hirs)[2], xlab="Treatment")
boxplot(hirs[,3]~hirs$Treatment,ylim=c(0,30), main=names(hirs)[3], xlab="Treatment")
boxplot(hirs[,4]~hirs$Treatment,ylim=c(0,30), main=names(hirs)[4], xlab="Treatment")
boxplot(hirs[,5]~hirs$Treatment,ylim=c(0,30), main=names(hirs)[5], xlab="Treatment")
par(mfrow=c(1,1))
par(mfrow=c(2,2))
boxplot(hirs[hirs$Treatment==0,2:5],ylim=c(0,30), main="Treatment 0")
boxplot(hirs[hirs$Treatment==1,2:5],ylim=c(0,30), main="Treatment 1")
boxplot(hirs[hirs$Treatment==2,2:5],ylim=c(0,30), main="Treatment 2")
boxplot(hirs[hirs$Treatment==3,2:5],ylim=c(0,30), main="Treatment 3")
par(mfrow=c(1,1))

pairs(hirs)
```

##Fit several GAM models (including semiparametric models) explaining $FGm12$ as a function of the variables that were measured at the beginning of the clinical trial (including $FGm0$) and $Treatment$ (treated as factor).


###1st GAM model: linear model through GAM (FGm12 ~ Treatment + FGm0 + SysPres + DiaPres + weight + height)

```{r}
library(mgcv)

gam1 <- gam(FGm12 ~ Treatment + FGm0 + SysPres + DiaPres + weight + height, data = iris)
summary(gam1)
```

###2nd GAM model: smooth model through GAM (FGm12 ~ Treatment + s(FGm0) + s(FGm0, by = Treatment) + s(SysPres) + s(DiaPres) + s(weight) + s(height))

```{r}
#S function : Function used in definition of smooth terms within gam model formula. The function does not evaluate a (spline) smooth - it exists purely to help set up a model using spline based smooths.

gam2 <- gam(FGm12 ~ Treatment + s(FGm0) + s(FGm0, by = Treatment) + s(SysPres) + s(DiaPres) + s(weight) + s(height), data = hirs)
summary(gam2)

# GCV score is the minimised generalised cross-validation (GCV) score of the GAM fitted.
```

From this model we can see that some variables can be removed as have a p-value that is not significant.
Also the variable SysPres which is significant has a edf of 1 so can be replaced by linear terms.

```{r}
plot(gam2, residuals = TRUE, shade=TRUE, seWithMean=TRUE, pages = 7)
```

###3rd GAM model: smooth model through GAM (FGm12 ~ Treatment + s(FGm0, by = Treatment) + SysPres)

```{r}
gam3 <- gam(FGm12 ~ Treatment + s(FGm0, by = Treatment) + SysPres, data = hirs) 
summary(gam3)
```

```{r}
plot(gam3, residuals = TRUE, shade=TRUE, seWithMean=TRUE)
```

#### Visualization of the joint effects of variables:

```{r}
vis.gam(gam3, view=c("Treatment","FGm0"), plot.type = "persp", theta=30, phi=30)
vis.gam(gam3, view=c("Treatment","FGm0"), plot.type = "contour")
```


###4rth GAM model: smooth model through GAM (FGm12 ~  s(FGm0, by = Treatment) + Treatment)

```{r}
gam4 <- gam(FGm12 ~ s(FGm0) + Treatment, data = hirs)
summary(gam4)
```

```{r}
plot(gam4, residuals = TRUE, shade=TRUE, seWithMean=TRUE)
```

####Visualization of the joint effects of variables:

```{r}
vis.gam(gam4, view=c("Treatment","FGm0"), plot.type = "persp", theta=30, phi=30)
vis.gam(gam4, view=c("Treatment","FGm0"), plot.type = "contour")
```

###5th GAM model: smooth model through GAM (FGm12 ~  s(FGm0, by = Treatment))

```{r}
gam5 <- gam(FGm12 ~ s(FGm0, by = Treatment), data = hirs)
summary(gam5)
```

```{r}
plot(gam5, residuals = TRUE, shade=TRUE, seWithMean=TRUE)
```

####Visualization of the joint effects of variables:

```{r}
vis.gam(gam5, view=c("Treatment","FGm0"), plot.type = "persp", theta=30, phi=30)
vis.gam(gam5, view=c("Treatment","FGm0"), plot.type = "contour")
```

###6th GAM model: smooth model through GAM (FGm12 ~ s(FGm0, by = Treatment) + SysPres + Treatment+ s(FGm0, SysPres)

```{r}
gam6 <- gam(FGm12 ~ s(FGm0, by = Treatment) + SysPres + Treatment+ s(FGm0, SysPres), data = hirs)
summary(gam6)
```

```{r}
plot(gam6, residuals = TRUE, shade=TRUE, seWithMean=TRUE)
```

####Visualization of the joint effects of variables:

```{r}
vis.gam(gam6, view=c("SysPres","FGm0"), plot.type = "persp", theta=30, phi=30)
vis.gam(gam6, view=c("SysPres","FGm0"), plot.type = "contour")

vis.gam(gam6, view=c("Treatment","FGm0"), plot.type = "persp", theta=30, phi=30)
vis.gam(gam6, view=c("Treatment","FGm0"), plot.type = "contour")

vis.gam(gam6, view=c("Treatment","SysPres"), plot.type = "persp", theta=30, phi=30)
vis.gam(gam6, view=c("Treatment","SysPres"), plot.type = "contour")

```

## ANOVA type tests 
```{r}
anova(gam1,gam2,test="F")
```

It is significant so model Gam2 explain better the variance than model 1.

```{r}
anova(gam3,gam2,test="F")
```

```{r}
anova(gam4,gam5,test="F")
```

```{r}
anova(gam6,gam3,test="F")
```

It is seen that the one that explains more variabiity and has the best fitting is the full gam model smoothed, which explains around the 50% of the variablity and has a $R^2_{adj} = 0.368$.

When we remove the non significant variables from this full model we can think about different gam models. The best models suggested has been gam4 which is the one that only takes into account the FGm0 and the Treatment and the gam6 which takes into account FGm0 by the Treatment, SysPres and the Treatment, and the smooth function of FGm0 together with SysPres. 
Gam4 has a $R^2_{adj} = 0.277$ and explains 34.1% of the variability. On the other hand, model gam6 has a $R^2_{adj} = 0.303$ and explains 42.2% of the variability. 
Taking into account the gam and anova results the simplest and best model to predict FGm12 using inicial measures of the beginning of the clinical trial is model gam6.



